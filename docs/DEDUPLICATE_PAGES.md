# Notion 页面去重说明

## 问题描述

在同步微信读书数据到 Notion 过程中，发现书架数据库中存在大量重复的书籍页面。这是由于同步过程中的 bug 或多次执行导致的。

- **发现时间**：2025-10-24
- **重复数量**：74 条记录中有 36 个 BookId 重复
- **需要删除**：37 个重复页面

## 去重策略

### 1. 重复识别方法
通过 `BookId` 字段识别重复。如果多条记录拥有相同的 `BookId`，则认为是重复。

### 2. 保留策略
- 对于每个 BookId，**保留创建时间最晚的记录**（最新创建的）
- 删除所有旧的副本，使用 Notion API 的 `archived` 功能（归档而非永久删除）

### 3. 为什么选择归档而不是删除
- **安全性**：归档可以恢复，真实删除不可逆
- **可追溯性**：保持历史记录的可见性
- **API 兼容性**：Notion 的 `archived` 标志比真实删除更安全

## 执行结果

### 去重前
```
总记录数：74
有效 BookId：38
重复 BookId：36（2 个记录无 BookId）
需要删除：37 条重复页面
```

### 去重后
```
总记录数：36
有效 BookId：36
重复 BookId：0
结果：✅ 完全去重
```

### 重复统计
最多的重复情况：
- **控糖革命** (BookId: 3300085869)：3 条重复 → 保留 1 条
- 其他 35 个 BookId：各 2 条重复 → 各保留 1 条

## 使用工具

### 文件位置
```
tests/find_and_delete_duplicates.py
```

### 使用方法

#### 1. 演练模式（推荐先执行）
预览将要删除的页面，不做实际修改：
```bash
python tests/find_and_delete_duplicates.py
```

输出示例：
```
🔍 演练模式：将要删除 37 个重复页面
  [1] 将删除: 控糖革命 (ID: 3300085869)
      Page ID: 2968ad53-45be-8158-86ea-c638b67313c4
  ...
```

#### 2. 实际执行模式
真实删除重复页面：
```bash
python tests/find_and_delete_duplicates.py --execute
```

输出示例：
```
🗑️  准备删除 37 个重复页面
  ✅ 已归档: 控糖革命 (ID: 3300085869)
     Page ID: 2968ad53-45be-8158-86ea-c638b67313c4
  ...
✨ 删除完成，共删除 37 个重复页面
```

## 改进建议

为了防止未来再出现重复，建议：

1. **在同步逻辑中添加检查**：在 `book.py` 中的 `main()` 函数增强重复检查
2. **添加事务支持**：确保同步操作的原子性
3. **定期清理**：定期运行去重工具确保数据质量
4. **日志记录**：记录每次同步的详细日志便于调查

## 相关代码

- **去重工具**：`tests/find_and_delete_duplicates.py`
- **重复检查方法**：`weread2notionpro/notion_helper.py#check_existing_books()`
- **书籍同步**：`weread2notionpro/book.py#main()`

## 状态

✅ **已完成**
- 2025-10-24：发现并删除了 37 个重复页面
- 数据库现在处于干净状态（36 本唯一书籍）
